services:
  app:
    build: .
    ports:
      - "8001:8000"
    volumes:
      - ./app:/usr/src/app
      - ./models:/usr/src/models
    env_file:
      - .env
    environment:
      - MODEL_PATH=/usr/src/models/classifier
    depends_on:
      - redis
      - qdrant
      - meilisearch
      - llm-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: on-failure

  celery-worker:
    build: .
    command: celery -A app.worker.celery_app worker --loglevel=info
    volumes:
      - ./app:/usr/src/app
      - ./models:/usr/src/models
    env_file:
      - .env
    environment:
      - MODEL_PATH=/usr/src/models/classifier
    depends_on:
      - redis
      - qdrant
      - meilisearch
      - llm-server
    restart: on-failure

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: always

  meilisearch:
    image: getmeili/meilisearch:latest
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=SuperSecure_42Asia_MasterKey # 데모용. 실제로는 .env 사용
    volumes:
      - meili_data:/meili_data
    restart: always

  llm-server:
    build:
      context: ./shimmy-source
    ports:
      - "11434:11434"
    volumes:
      - ./models:/models
    environment:
      - SHIMMY_MODEL_DIR=/models
      - SHIMMY_WEB_PORT=11434
    # ◀◀◀ [수정] 아래 deploy 블록을 삭제/주석 처리 ◀◀◀
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    restart: always

volumes:
  redis_data:
  qdrant_data:
  meili_data: